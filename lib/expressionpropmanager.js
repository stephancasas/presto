"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const expressionprop_1=require("./expressionprop"),cheerio=require("cheerio"),error_1=require("../utils/error"),edge_lexer_1=require("edge-lexer"),tokenmagic_1=require("../utils/tokenmagic"),utils_1=require("../utils/utils");class ExpressionPropManager{constructor(e){this.expression=e,this.componentProps=e.component.propManager,this.prepareProps()}prepareProps(){const e=this.expression.attributeManager.getPropertyAttributes();this.props=[],e.map(e=>{this.props.push(new expressionprop_1.default(e))}),this.componentProps.props.map(e=>{if(this.props.filter(t=>t.key===e.key).length>0)return;if(""===e.defaultValue)return;const t={key:e.key,value:e.defaultValue};this.props.push(new expressionprop_1.default(t))})}getProp(e){var t;e=e.toLowerCase();const r=this.props.filter(t=>t.key===e),s=null===(t=this.expression.output)||void 0===t?void 0:t.props[e];return 0===r.length?void 0===s?new expressionprop_1.default({key:e,value:""},!0):new expressionprop_1.default({key:e,value:s}):r[0]}getPropValue(e,t=""){const r=this.componentProps.getProp(e),s=this.getProp(e),o=void 0===r?s.empty?void 0:s.value:r.getValue(s);return""===t?o:this.pipeValue(o,t)}pipeValue(e,t){const r=void 0===e?"":e,s=this.expression.component.pipes,o=this.expression.output.pipes;return t in s?s[t](r):t in o?o[t](r):e}getMagicProps(){return this.props.filter(e=>e.isMagic)}getNormalProps(){return this.props.filter(e=>!e.isMagic)}processStandardTokens(){if(0===this.getNormalProps().length)return;const e=new edge_lexer_1.Tokenizer(this.expression.source,{},{filename:""});e.parse();const t=e.tokens.filter(e=>"mustache"===e.type);let r=[];t.map(e=>{const t=e.properties.jsArg;let s=t,o="";if(s.indexOf("|")>=0){const e=s.split("|");e.length>2&&error_1.error(new Error(`Property exposed as "{{${s}}}" implements more than one pipe.`)),o=e[1].trim(),s=e[0]}const i=""+s.trim().toLowerCase(),p=this.getProp(i);let n=r.filter(e=>e.key===i&&e.pipe===o);if(p.isMagic)return;let a=this.getPropValue(i,o);n.length>0&&(a=n[0].value),r.push({key:i,pipe:o,value:a}),void 0!==a&&(this.expression.source=this.expression.source.replace(`{{${t}}}`,a))})}processMagicTokens(){if(0===this.getMagicProps().length)return;let e=this.expression.source,t=!0;for(;t;){const r=new edge_lexer_1.Tokenizer(e,{},{filename:""});r.parse();const s=r.tokens.filter(e=>"mustache"===e.type);if(0===s.length)break;t=1!==s.length;let o=void 0;s.map(t=>{"html"!==tokenmagic_1.resolveTokenContext(e,t).rel&&tokenmagic_1.hasHtmlTokens(e)||void 0!==o||(o=t)});const i=o.properties.jsArg,p=this.getPropValue(i.trim()),n=tokenmagic_1.resolveTokenCoordinates(e,o),a=tokenmagic_1.resolveTokenContext(e,o);if("html"===a.rel){e=utils_1.replaceAt(e,n-2,`{{${i}}}`,`<snowblade-magic>${p}</snowblade-magic>`);const t=cheerio.load(e);let r=t("snowblade-magic").parent();if("name"in r[0]){const e=r[0];if("slot"===e.name&&"snowblade"in e.attribs){const e=r.parent();t(e).html(r.html()),r=e}}let s=r.html();s=s.replace("<snowblade-magic>","${"),s=s.replace("</snowblade-magic>","}"),tokenmagic_1.unsafeChars.map(e=>{const t=new RegExp(e.char,"g");s=s.replace(t,e.sub)});let o={};o["x-html"]=`\`${s}\``,r.attr(o),r.empty(),e=t("body").html()}else{const t="${"+p+"} snowblade-magic";e=utils_1.replaceAt(e,n-2,`{{${i}}}`,t),e=utils_1.replaceAt(e,n-(a.offset-1),"","snowblade-magic ")}}this.expression.source=e}}exports.default=ExpressionPropManager;