"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const expressionprop_1=require("./expressionprop"),cheerio=require("cheerio"),error_1=require("../utils/error"),edge_lexer_1=require("edge-lexer"),tokenmagic_1=require("../utils/tokenmagic"),utils_1=require("../utils/utils");class ExpressionPropManager{constructor(e){this.expression=e,this.componentProps=e.component.propManager,this.prepareProps()}prepareProps(){const e=this.expression.attributeManager.getPropertyAttributes();this.props=[],e.map(e=>{this.props.push(new expressionprop_1.default(e))}),this.componentProps.props.map(e=>{if(this.props.filter(r=>r.key===e.key).length>0)return;if(""===e.defaultValue)return;const r={key:e.key,value:e.defaultValue};this.props.push(new expressionprop_1.default(r))})}getProp(e){var r;e=e.toLowerCase();const t=this.props.filter(r=>r.key===e),s=null===(r=this.expression.output)||void 0===r?void 0:r.props[e];return 0===t.length?void 0===s?new expressionprop_1.default({key:e,value:""},!0):new expressionprop_1.default({key:e,value:s}):t[0]}getPropValue(e,r=""){const t=this.componentProps.getProp(e),s=this.getProp(e),o=void 0===t?void 0:t.getValue(s);return""===r?o:this.pipeValue(o,r)}pipeValue(e,r){const t=void 0===e?"":e,s=this.expression.component.pipes,o=this.expression.output.pipes;return r in s?s[r](t):r in o?o[r](t):e}getMagicProps(){return this.props.filter(e=>e.isMagic)}getNormalProps(){return this.props.filter(e=>!e.isMagic)}processStandardTokens(){if(0===this.getNormalProps().length)return;const e=new edge_lexer_1.Tokenizer(this.expression.source,{},{filename:""});e.parse();const r=e.tokens.filter(e=>"mustache"===e.type);let t=[];r.map(e=>{const r=e.properties.jsArg;let s=r,o="";if(s.indexOf("|")>=0){const e=s.split("|");e.length>2&&error_1.error(new Error(`Property exposed as "{{${s}}}" implements more than one pipe.`)),o=e[1].trim(),s=e[0]}const i=""+s.trim().toLowerCase(),p=this.getProp(i);let n=t.filter(e=>e.key===i&&e.pipe===o);if(p.isMagic)return;let a=this.getPropValue(i,o);n.length>0&&(a=n[0].value),t.push({key:i,pipe:o,value:a}),void 0!==a&&(this.expression.source=this.expression.source.replace(`{{${r}}}`,a))})}processMagicTokens(){if(0===this.getMagicProps().length)return;let e=this.expression.source,r=[],t=!0;for(;t;){const s=new edge_lexer_1.Tokenizer(e,{},{filename:""});s.parse();let o=s.tokens.filter(e=>"mustache"===e.type);if(r.forEach(e=>{const{jsArg:r}=e.properties;o=o.filter(e=>e.properties.jsArg!==r)}),0===o.length)break;t=1!==o.length;let i=void 0;o.map(r=>{"html"!==tokenmagic_1.resolveTokenContext(e,r).rel&&tokenmagic_1.hasHtmlTokens(e)||void 0!==i||(i=r)});const p=i.properties.jsArg,n=this.getPropValue(p.trim()),a=tokenmagic_1.resolveTokenCoordinates(e,i),l=tokenmagic_1.resolveTokenContext(e,i);if(void 0!==n)if("html"===l.rel){e=utils_1.replaceAt(e,a-2,`{{${p}}}`,`<snowblade-magic>${n}</snowblade-magic>`);const r=cheerio.load(e);let t=r("snowblade-magic").parent();if("name"in t[0]){const e=t[0];if("slot"===e.name&&"snowblade"in e.attribs){const e=t.parent();r(e).html(t.html()),t=e}}let s=t.html();s=s.replace("<snowblade-magic>","${"),s=s.replace("</snowblade-magic>","}"),tokenmagic_1.unsafeChars.map(e=>{const r=new RegExp(e.char,"g");s=s.replace(r,e.sub)});let o={};o["x-html"]=`\`${s}\``,t.attr(o),t.empty(),e=r("body").html()}else{const r="${"+n+"} snowblade-magic";e=utils_1.replaceAt(e,a-2,`{{${p}}}`,r),e=utils_1.replaceAt(e,a-(l.offset-1),"","snowblade-magic ")}else r.push(i)}this.expression.source=e}}exports.default=ExpressionPropManager;