"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.escapeTags=exports.Output=void 0;const utils_1=require("../utils/utils"),error_1=require("../utils/error"),tokenmagic_1=require("../utils/tokenmagic"),utils_2=require("../utils/utils"),expression_1=require("./expression"),cheerio=require("cheerio"),prettier=require("prettier"),html_minifier_1=require("html-minifier"),fs=require("fs"),logging_1=require("../utils/logging");class Output{constructor(r,e){this.instance=r,this.output=e,utils_1.linkProperties(this,this.instance,["componentProvider","component"]),this.prepareOutput()}prepareOutput(){const r={type:"html",formatting:"tidy",comments:!1,mustache:!0,props:{},pipes:{}},{type:e,file:t,formatting:o,comments:i,mustache:s,props:p,pipes:n}=this.output;this.file=utils_2.absolutePath(void 0===t?error_1.error(error_1.error(error_1.errConfigMissingProp("output.file"))):"string"!=typeof t?error_1.error(error_1.errConfigBadPropType("output.file",t)):t),this.type=void 0===e?r.type:"string"!=typeof e?error_1.error(error_1.errConfigBadPropType("output.type",e)):["html"].includes(e.toLowerCase())?e:error_1.error(error_1.errConfigBadPropValue("output.type",e)),this.formatting=void 0===o?r.formatting:"string"!=typeof o?error_1.error(error_1.errConfigBadPropType("output.formatting",o)):["none","pretty","minify"].includes(o.toLowerCase())?o:error_1.error(error_1.errConfigBadPropValue("output.formatting",o)),this.comments=void 0===i?r.comments:"boolean"!=typeof i?error_1.error(error_1.errConfigBadPropType("output.comments",i)):i,this.mustache=void 0===s?r.mustache:"boolean"!=typeof s?error_1.error(error_1.errConfigBadPropType("mustache",s)):s,this.props=void 0===p?r.props:"object"!=typeof p?error_1.error(error_1.errConfigBadPropType("output.props",p)):Array.isArray(p)?error_1.error(error_1.errConfigBadPropValue("output.props",p)):p,this.pipes=void 0===n?r.pipes:"object"!=typeof n?error_1.error(error_1.errConfigBadPropType("output.pipes",n)):Array.isArray(n)?error_1.error(error_1.errConfigBadPropValue("output.pipes",n)):n}buildBaseExpression(){this.$=cheerio.load("<snowblade-root/>");const r=this.$("snowblade-root")[0];this.expression=new expression_1.Expression(this,r);let e=this.expression.html;e=this.collapseHeadElements(e),e=tokenmagic_1.implementMagicAttrs(e),exports.escapeTags.map(r=>{const t=new RegExp(`((?<=<)${r.escaped})|((?<=</)${r.escaped})`,"g");e=e.replace(t,r.unescaped)}),"pretty"===this.formatting?e=prettier.format(e,{parser:"html"}):"minify"===this.formatting&&(e=html_minifier_1.minify(e)),fs.writeFileSync(this.file,e),logging_1.progress(`Snowblade successfully compiled to \`${this.file}\``)}collapseHeadElements(r){const e=cheerio.load(r);let t=[];return e("snowblade-head").each((r,o)=>{t.push(e(o).html()),e(o).remove()}),e("head").first().html(t.join("\n").trim()),e.html()}}exports.Output=Output,exports.escapeTags=[{escaped:"snowblade-template",unescaped:"template"}];