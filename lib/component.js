"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Component=exports.TagType=exports.Tag=exports.ComponentOccurrence=exports.ComponentRenameType=exports.ComponentImplementation=void 0;const snowblade_1=require("./snowblade"),utils_1=require("../utils/utils"),cheerio=require("cheerio"),fs=require("fs"),url_1=require("url"),md5=require("md5"),babel=require("@babel/core"),componentimportmanager_1=require("./componentimportmanager"),error_1=require("../utils/error"),componentpropmanager_1=require("./componentpropmanager"),componentslotmanager_1=require("./componentslotmanager"),output_1=require("./output"),path=require("path"),utils_2=require("../utils/utils");class ComponentImplementation{constructor(e,t){this.context=e,this.source=e.pureSource,this.component=t,this.buildOccurrences()}buildOccurrences(){const e=this.component.name,t=RegExp(`<${e}[^/]*/>`,"g"),s=RegExp(`(<${e}[^>/<]*>)`,"g"),r=RegExp(`</${e}>`,"g");let n;for(this.selfClose=[];null!==(n=t.exec(this.source));)this.selfClose.push(new ComponentOccurrence({literal:n[0],start:n.index,end:t.lastIndex,type:TagType.SELF}));for(this.startTags=[];null!==(n=s.exec(this.source));)this.startTags.push({literal:n[0],start:n.index,end:s.lastIndex,type:TagType.START});for(this.closeTags=[];null!==(n=r.exec(this.source));)this.closeTags.push({literal:n[0],start:n.index,end:r.lastIndex,type:TagType.END});this.occurrences=[],this.startTags.forEach(this.resolveTagPairs),this.occurrences=this.occurrences.concat(this.selfClose)}resolveTagPairs(e,t){t<this.startTags.length-1&&this.startTags[t+1].start<this.closeTags[0].start?this.resolveTagPairs(e,t+1):this.occurrences.push(new ComponentOccurrence(e,this.closeTags.shift()))}tokenizeOccurrences(){let e=this.source;return this.occurrences.forEach(t=>{const s=(null==t?void 0:t.endTag)?"¿":"Ɛ",{startTag:r}=t,n=`<${s}${utils_1.fill(r.literal.length-3,"~")}>`;if(e=utils_2.replaceAt(e,r.start,r.literal,n),!(null==t?void 0:t.endTag))return;const{endTag:o}=t,a=`<¡${utils_1.fill(o.literal.length-3,"~")}>`;e=utils_2.replaceAt(e,o.start,o.literal,a)}),e}processRename(e){let t=this.tokenizeOccurrences();const s=new RegExp({NAME:`(((<)|(</))${e.oldValue})`,PROPERTY:"::"+e.oldValue}[e.type]);this.occurrences.forEach(r=>{const n=new RegExp((null==r?void 0:r.endTag)?"<¿~*>":"<Ɛ~*>"),o=r.startTag.literal,a="NAME"===e.type?"<":"::";if(t=t.replace(n,o.replace(s,`${a}${e.newValue}`)),!(null==r?void 0:r.endTag))return;const i="NAME"===e.type?e.newValue:this.component.name;t=t.replace(/<¡~*>/,`</${i}>`)}),fs.writeFileSync(this.context.file,t),this.context.init()}}var ComponentRenameType,TagType;exports.ComponentImplementation=ComponentImplementation,function(e){e.NAME="NAME",e.PROPERTY="PROPERTY"}(ComponentRenameType=exports.ComponentRenameType||(exports.ComponentRenameType={}));class ComponentOccurrence{constructor(e,t){this.startTag=e,this.endTag=t}}exports.ComponentOccurrence=ComponentOccurrence;class Tag{}exports.Tag=Tag,function(e){e.START="START",e.END="END",e.SELF="SELF"}(TagType=exports.TagType||(exports.TagType={}));class Component{constructor(e,t){this.context=e,this.path=t,utils_1.linkProperties(this,this.context,["componentProvider"]),this.init()}init(){this.readSource(),this.preparePipes(),this.parseComponentMeta(),this.prepareManagers(),this.escapeSource(),this.parseComponentImplementations(),this.prepareDom()}parseComponentImplementations(){this.componentImplementations=[],this.importManager.imports.forEach(e=>{const t=null==e?void 0:e.expressionName;if(void 0===t)return;const s=new RegExp(`((?<=<)${t})|((?<=</)${t})`,"gi");null!==this.source.match(s)&&this.componentImplementations.push(new ComponentImplementation(this,e))})}preparePipes(){const e=cheerio.load(this.source),t=[...e("script[snowblade]")];if(0===t.length)return void(this.pipes={});let s=e(t).html().trim();const r=md5(this.path.concat(s)),n=path.resolve(`${path.resolve(__dirname)}${path.sep}..${path.sep}.pipes`);fs.mkdirSync(n,{recursive:!0});const o=url_1.pathToFileURL(`${n}${path.sep}${r}.cjs`).pathname;try{fs.realpathSync(o)}catch(e){s=s.replace(/function(?=\s*.*\(.*\)\s*{)/g,"export function");const t=babel.transform(s,{presets:["@babel/preset-env"]}).code;fs.writeFileSync(o,t)}this.pipes=require(o)}readSource(){try{this.file=fs.realpathSync(this.path),this.source=fs.readFileSync(this.file,{encoding:"utf-8"}),this.pureSource=""+this.source}catch(e){error_1.error("ENOENT"===e.code?error_1.errComponentNoFile(this):e)}}escapeSource(){this.escapeSelfClosing(),this.escapeUnsafeTags(),this.escapeShorthand(),this.escapeExpressions()}prepareDom(){const e=cheerio.load(this.source);["script[snowblade]","meta[snowblade]","link[snowblade]"].map(t=>{e(t).each((t,s)=>{e(s).remove()})});const t=e("head"),s=`<snowblade-head>${t.html()}</snowblade-head>`,r=e("body");r.html(`${s}${r.html()}`),t.empty(),this.source=r.html()}escapeExpressions(){this.importManager.imports.map(e=>{const t=new RegExp(`((?<=<)${e.name})|((?<=</)${e.name})`,"g");this.source=this.source.replace(t,e.expressionName)})}escapeUnsafeTags(){output_1.escapeTags.map(e=>{const t=new RegExp(`((?<=<)${e.unescaped})|((?<=</)${e.unescaped})`,"gi");this.source=this.source.replace(t,e.escaped)})}parseComponentMeta(){if(this.isInputComponent)return;const e=cheerio.load(this.source);if(this.meta=e("meta[snowblade]")[0],void 0===this.meta)return error_1.error(error_1.errComponentNoMeta(this.file));this.name=this.meta.attribs.name;const t=this.name.replace(/[A-Z]/g,e=>"_"+e.toLowerCase());this.expressionName="snowblade-"+t}prepareManagers(){this.propManager=new componentpropmanager_1.default(this),this.importManager=new componentimportmanager_1.default(this),this.isInputComponent||(this.slotManager=new componentslotmanager_1.default(this))}escapeShorthand(){[{seq:/\?snowblade/,sub:"snowblade-opt:"},{seq:"::!",sub:"snowblade-false:"}].map(e=>{let t=new RegExp(e.seq,"g");this.source=this.source.replace(t,e.sub)})}escapeSelfClosing(){this.importManager.imports.map(e=>{const t=new RegExp(`<${e.name}(.*)/>`,"gi");this.source=this.source.replace(t,`<${e.name}$1></${e.name}>`)})}get isInputComponent(){var e;return this.context instanceof snowblade_1.default&&(null===(e=this.context)||void 0===e?void 0:e.input)===this.path}}exports.Component=Component;