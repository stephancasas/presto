"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Component=void 0;const snowblade_1=require("./snowblade"),utils_1=require("../utils/utils"),cheerio=require("cheerio"),fs=require("fs"),url_1=require("url"),md5=require("md5"),babel=require("@babel/core"),componentimportmanager_1=require("./componentimportmanager"),error_1=require("../utils/error"),componentpropmanager_1=require("./componentpropmanager"),componentslotmanager_1=require("./componentslotmanager"),output_1=require("./output"),path=require("path");class Component{constructor(e,t){this.context=e,this.path=t,utils_1.linkProperties(this,this.context,["componentProvider"]),this.readSource(),this.preparePipes(),this.parseComponentMeta(),this.prepareManagers(),this.escapeSource(),this.prepareDom()}preparePipes(){const e=cheerio.load(this.source),t=[...e("script[snowblade]")];if(0===t.length)return void(this.pipes={});let s=e(t).html().trim();const r=md5(this.path.concat(s)),o=path.resolve(`${path.resolve(__dirname)}${path.sep}..${path.sep}.pipes`);fs.mkdirSync(o,{recursive:!0});const a=url_1.pathToFileURL(`${o}${path.sep}${r}.cjs`).pathname;try{fs.realpathSync(a)}catch(e){s=s.replace(/function(?=\s*.*\(.*\)\s*{)/g,"export function");const t=babel.transform(s,{presets:["@babel/preset-env"]}).code;fs.writeFileSync(a,t)}this.pipes=require(a)}readSource(){try{this.file=fs.realpathSync(this.path),this.source=fs.readFileSync(this.file,{encoding:"utf-8"})}catch(e){error_1.error("ENOENT"===e.code?error_1.errComponentNoFile(this):e)}}escapeSource(){this.escapeSelfClosing(),this.escapeUnsafeTags(),this.escapeShorthand(),this.escapeExpressions()}prepareDom(){const e=cheerio.load(this.source);["script[snowblade]","meta[snowblade]","link[snowblade]"].map(t=>{e(t).each((t,s)=>{e(s).remove()})});const t=e("head"),s=`<snowblade-head>${t.html()}</snowblade-head>`,r=e("body");r.html(`${s}${r.html()}`),t.empty(),this.source=r.html()}escapeExpressions(){this.importManager.imports.map(e=>{const t=new RegExp(`((?<=<)${e.name})|((?<=</)${e.name})`,"g");this.source=this.source.replace(t,e.expressionName)})}escapeUnsafeTags(){output_1.escapeTags.map(e=>{const t=new RegExp(`((?<=<)${e.unescaped})|((?<=</)${e.unescaped})`,"gi");this.source=this.source.replace(t,e.escaped)})}parseComponentMeta(){if(this.isInputComponent)return;const e=cheerio.load(this.source);if(this.meta=e("meta[snowblade]")[0],void 0===this.meta)return error_1.error(error_1.errComponentNoMeta(this.file));this.name=this.meta.attribs.name;const t=this.name.replace(/[A-Z]/g,e=>"_"+e.toLowerCase());this.expressionName="snowblade-"+t}prepareManagers(){this.propManager=new componentpropmanager_1.default(this),this.importManager=new componentimportmanager_1.default(this),this.isInputComponent||(this.slotManager=new componentslotmanager_1.default(this))}escapeShorthand(){[{seq:/\?snowblade/,sub:"snowblade-opt:"},{seq:"::!",sub:"snowblade-false:"}].map(e=>{let t=new RegExp(e.seq,"g");this.source=this.source.replace(t,e.sub)})}escapeSelfClosing(){this.importManager.imports.map(e=>{const t=new RegExp(`<${e.name}(.*)/>`,"gi");this.source=this.source.replace(t,`<${e.name}$1></${e.name}>`)})}get isInputComponent(){var e;return this.context instanceof snowblade_1.default&&(null===(e=this.context)||void 0===e?void 0:e.input)===this.path}}exports.Component=Component;