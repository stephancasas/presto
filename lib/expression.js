"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.Expression=void 0;const utils_1=require("../utils/utils"),expressionattributemanager_1=require("./expressionattributemanager"),cheerio=require("cheerio"),expressionpropmanager_1=require("./expressionpropmanager"),output_1=require("./output");class Expression{constructor(e,t){this.context=e,this.element=t,this.context instanceof output_1.Output?this.output=this.context:utils_1.linkProperties(this,this.context,["output"]),this.initializeModules(),this.processWrap(),this.escapeUnsafeTags(),this.processProps(),this.commitDom(),this.processSlots(),this.next()}initializeModules(){const e=this.context.component.importManager;if(this.component=e.getComponentByExpressionName(this.element.name),this.source=this.component.source,this.component.isInputComponent){const e=new RegExp("((?<=<)head)|((?<=</)head)","gi");this.source=this.source.replace(e,"snowblade-head")}this.attributeManager=new expressionattributemanager_1.default(this),this.propManager=new expressionpropmanager_1.default(this)}processProps(){this.propManager.processStandardTokens(),this.propManager.processMagicTokens()}processWrap(){let e=this.attributeManager.getActionAttribute("wrap");void 0!==e&&(e=e.toLowerCase(),this.source=`<${e}>${this.source}</${e}>`)}commitDom(){this.$=cheerio.load(this.source)}processSlots(){const e=this.context.$(this.element).html();this.$("slot[snowblade]").each((t,s)=>{const i=this.$(s).html();""===e.trim()?this.$(s).replaceWith(i):this.$(s).replaceWith(e)})}escapeUnsafeTags(){output_1.escapeTags.map(e=>{const t=new RegExp(`((?<=<)${e.unescaped})|((?<=</)${e.unescaped})`,"gi");this.source=this.source.replace(t,e.escaped)})}next(){this.attributeManager.getAssignedAttributes().map(e=>{[...this.$("body").children()].map(t=>{let s={};s[e.key]=e.key in t.attribs?`${t.attribs[e.key]} ${e.value}`:e.value,cheerio(t).attr(s)})}),this.component.importManager.imports.map(e=>{[...this.$(e.expressionName)].map(e=>{const t=new Expression(this,e);cheerio(e).replaceWith(cheerio(t.$("body")[0]).html())})}),this.html=this.$.html()}}exports.Expression=Expression;